<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NMS.TXT - A Text-Based Space Exploration Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <!-- Header -->
    <header>
        <h1>
            <img src="assets/logo.svg" alt="NMS.TXT" width="68" height="14">
        </h1>
        <button class="panel-toggle" id="settings-btn" aria-label="Open settings">settings</button>
    </header>

    <!-- Main game area -->
    <main>
        <!-- Narrative display -->
        <div id="narrative" role="article" data-log-number="00000">
            <!-- Game narrative will be displayed here -->
        </div>

        <!-- Dice roll result -->
        <div id="dice-result" class="hidden" role="status" aria-live="polite">
            <!-- Dice results will be displayed here -->
        </div>

        <!-- Action options -->
        <section id="actions">
            <div id="options" role="menu" aria-label="Available actions">
                <!-- Action buttons will be dynamically generated here -->
            </div>

            <!-- Custom action form -->
            <form id="custom-action-form">
                <input
                    type="text"
                    id="custom-action-input"
                    placeholder="Or type your own action..."
                    autocomplete="off"
                    aria-label="Custom action input"
                />
                <button type="submit" id="custom-action-submit" aria-label="Submit custom action">â†’</button>
            </form>
        </section>

        <!-- Error message -->
        <div id="error-message" role="alert" aria-live="assertive"></div>

        <!-- Loading indicator -->
        <div id="loading" role="status" aria-live="polite"></div>

        <!-- Model download progress -->
        <div id="model-loading" class="model-loading-container hidden">
            <div id="model-loading-text">Downloading AI model...</div>
            <div id="model-loading-progress" class="model-loading-progress"></div>
        </div>

        <!-- Info panel -->
        <div id="info-panel" role="status">
            <div class="info-divider-horizontal"></div>
            <div class="info-row">
                <div class="info-item">
                    <div class="info-label">HULL INTEGRITY</div>
                    <div class="info-value" id="ship-health">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">FUEL RESERVES</div>
                    <div class="info-value" id="fuel">0</div>
                </div>
            </div>
            <div class="info-divider-horizontal"></div>
            <div class="info-row">
                <div class="info-item">
                    <div class="info-content">
                        <div class="info-sublabel">LOCATION</div>
                        <div class="info-subvalue" id="location-display">UNKNOWN</div>
                    </div>
                    <div class="info-icon">
                        <svg width="32" height="34" viewBox="0 0 32 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12.6689 23L15.0556 18L15.0556 4.37114e-08L16.0556 0L16.0556 18L18.4423 23H12.6689Z" fill="white"/>
                            <path d="M15.5556 1H18.5556C19.1079 1 19.5556 1.44772 19.5556 2V6H15.5556V1Z" fill="white"/>
                            <path d="M19.5556 3H23.5556V8H20.5556C20.0033 8 19.5556 7.55228 19.5556 7V3Z" fill="white"/>
                            <path d="M15.5556 22C21.4651 22 26.7624 24.659 30.3615 28.8655C32.229 31.0481 30.3585 34 27.486 34H3.62516C0.752608 34 -1.11789 31.0481 0.749617 28.8655C4.34872 24.659 9.64608 22 15.5556 22Z" fill="#7695C7"/>
                            <path d="M15.5556 22C16.6471 22 17.7181 22.0912 18.7611 22.2656C19.2907 23.8543 20.7893 25 22.556 25C23.3733 24.9999 24.1327 24.7538 24.7659 24.333C26.5785 25.3157 28.2216 26.5797 29.64 28.0674C29.2845 28.0247 28.923 28 28.556 28C24.6376 28 21.3053 30.5047 20.0697 34H3.62516C0.752608 34 -1.11789 31.0481 0.749617 28.8655C1.34257 28.1725 1.98214 27.522 2.66243 26.918C3.07737 28.6846 4.6628 30 6.55598 30C8.76494 29.9998 10.556 28.209 10.556 26C10.556 24.8327 10.0557 23.782 9.25813 23.0508C11.2347 22.3693 13.3526 22 15.5556 22Z" fill="#B64024"/>
                        </svg>
                    </div>
                </div>
                <div class="info-item">
                    <div class="info-content">
                        <div class="info-sublabel">GALAXY CENTER</div>
                        <div class="info-subvalue" id="distance-display">0 LY</div>
                    </div>
                    <div class="info-icon">
                        <svg width="40" height="34" viewBox="0 0 40 34" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M39.5 17C39.5 26.3888 31.8888 34 22.5 34C13.1112 34 5.5 26.3888 5.5 17C5.5 7.61116 13.1112 0 22.5 0C31.8888 0 39.5 7.61116 39.5 17Z" fill="#0C1A1B"/>
                            <path d="M22.5 33V34C22.3278 34 22.1563 33.9963 21.9854 33.9912L22.0146 32.9932C22.1757 32.998 22.3377 33 22.5 33ZM23.0137 33.9912C22.8431 33.9963 22.6718 34 22.5 34V33C22.6623 33 22.8243 32.998 22.9854 32.9932L23.0137 33.9912ZM20.0908 32.8203C20.4075 32.8681 20.7272 32.9066 21.0498 32.9355L20.9609 33.9297C20.6181 33.8989 20.2781 33.8584 19.9414 33.8076L20.0908 32.8203ZM24.9092 32.8203L25.0576 33.8076C24.7209 33.8584 24.381 33.8989 24.0381 33.9297L23.9502 32.9355C24.2728 32.9066 24.5925 32.8681 24.9092 32.8203ZM18.2012 32.416C18.5103 32.502 18.8232 32.5789 19.1396 32.6465L18.9307 33.623C18.5943 33.5512 18.2613 33.4704 17.9326 33.3789L18.2012 32.416ZM27.0664 33.3789C26.7377 33.4704 26.4048 33.5512 26.0684 33.623L25.8604 32.6465C26.1768 32.5789 26.4897 32.502 26.7988 32.416L27.0664 33.3789ZM16.376 31.7861C16.6724 31.9091 16.9732 32.0236 17.2783 32.1289L16.9521 33.0723C16.6277 32.9603 16.3074 32.8397 15.9922 32.709L16.376 31.7861ZM29.0068 32.709C28.6916 32.8397 28.3713 32.9603 28.0469 33.0723L27.7217 32.1289C28.0268 32.0236 28.3276 31.9091 28.624 31.7861L29.0068 32.709ZM14.6396 30.9395C14.9196 31.0977 15.2051 31.2482 15.4951 31.3896L15.0566 32.2871C14.7482 32.1366 14.4451 31.9768 14.1475 31.8086L14.6396 30.9395ZM30.8516 31.8086C30.5539 31.9768 30.2509 32.1366 29.9424 32.2871L29.5049 31.3896C29.7949 31.2482 30.0804 31.0977 30.3604 30.9395L30.8516 31.8086ZM13.0176 29.8887C13.2767 30.0797 13.5418 30.2631 13.8125 30.4385L13.54 30.8574L13.3867 31.0957L13.2686 31.2764C12.9809 31.09 12.6992 30.8953 12.4238 30.6924L13.0176 29.8887ZM32.5752 30.6924C32.2998 30.8953 32.0181 31.09 31.7305 31.2764L31.459 30.8584L31.1875 30.4385C31.4582 30.2631 31.7233 30.0797 31.9824 29.8887L32.5752 30.6924ZM11.5332 28.6504C11.7678 28.8713 12.0092 29.0854 12.2568 29.292L11.6162 30.0586C11.3533 29.8392 11.0977 29.6115 10.8486 29.377L11.1904 29.0146L11.5332 28.6504ZM34.1504 29.377C33.9013 29.6115 33.6457 29.8392 33.3828 30.0586L32.7432 29.292C32.9908 29.0854 33.2322 28.8713 33.4668 28.6504L34.1504 29.377ZM10.208 27.2432C10.4146 27.4908 10.6287 27.7322 10.8496 27.9668L10.4854 28.3096L10.1221 28.6504C9.88751 28.4013 9.65976 28.1457 9.44043 27.8828L10.208 27.2432ZM35.5586 27.8828C35.3392 28.1457 35.1115 28.4013 34.877 28.6504L34.1504 27.9668C34.3713 27.7322 34.5854 27.4908 34.792 27.2432L35.5586 27.8828ZM9.06152 25.6875C9.23691 25.9582 9.42033 26.2233 9.61133 26.4824L8.80664 27.0752C8.60371 26.7999 8.40902 26.5181 8.22266 26.2305L9.06152 25.6875ZM36.6719 26.1631L36.7764 26.2305C36.59 26.5181 36.3953 26.7998 36.1924 27.0752L35.3887 26.4824C35.5797 26.2233 35.7631 25.9582 35.9385 25.6875L36.6719 26.1631ZM8.11035 24.0049C8.25185 24.2949 8.40232 24.5804 8.56055 24.8604L7.69043 25.3516C7.5222 25.0539 7.36236 24.7509 7.21191 24.4424L8.11035 24.0049ZM37.7871 24.4424C37.6366 24.7509 37.4768 25.0539 37.3086 25.3516L36.4395 24.8604C36.5977 24.5804 36.7482 24.2949 36.8896 24.0049L37.7871 24.4424ZM7.37109 22.2217C7.47638 22.5268 7.59094 22.8276 7.71387 23.124L6.79004 23.5068C6.65933 23.1916 6.53871 22.8713 6.42676 22.5469L7.37109 22.2217ZM38.5723 22.5469C38.4603 22.8713 38.3397 23.1916 38.209 23.5068L37.2861 23.124C37.4091 22.8276 37.5236 22.5268 37.6289 22.2217L38.5723 22.5469ZM6.85352 20.3604C6.92112 20.6768 6.99798 20.9897 7.08398 21.2988L6.12012 21.5664C6.02868 21.2377 5.94784 20.9048 5.87598 20.5684L6.85352 20.3604ZM39.123 20.5684C39.0512 20.9048 38.9704 21.2377 38.8789 21.5664L37.916 21.2988C38.002 20.9897 38.0789 20.6768 38.1465 20.3604L39.123 20.5684ZM6.56445 18.4502C6.59341 18.7728 6.6319 19.0925 6.67969 19.4092L6.18457 19.4834L6.18555 19.4844L5.69141 19.5576C5.6406 19.2209 5.60009 18.881 5.56934 18.5381L6.56445 18.4502ZM39.4297 18.5381C39.3989 18.881 39.3584 19.2209 39.3076 19.5576L38.8145 19.4844L38.3203 19.4092C38.3681 19.0925 38.4066 18.7728 38.4355 18.4502L39.4297 18.5381ZM5.5 17C5.5 16.8278 5.50273 16.6563 5.50781 16.4854L6.50684 16.5146C6.50205 16.6757 6.5 16.8377 6.5 17C6.5 17.1623 6.50205 17.3243 6.50684 17.4854L5.50781 17.5137C5.50275 17.3431 5.5 17.1718 5.5 17ZM39.5 17C39.5 17.1718 39.4963 17.3431 39.4912 17.5137L38.4932 17.4854C38.498 17.3243 38.5 17.1623 38.5 17C38.5 16.8377 38.498 16.6757 38.4932 16.5146L39.4912 16.4854C39.4963 16.6563 39.5 16.8278 39.5 17ZM6.18555 14.5156L6.67969 14.5908C6.6319 14.9075 6.59341 15.2272 6.56445 15.5498L5.56934 15.4609C5.6001 15.1181 5.64058 14.7781 5.69141 14.4414L6.18555 14.5156ZM39.3076 14.4414C39.3584 14.7781 39.3989 15.1181 39.4297 15.4609L38.4355 15.5498C38.4066 15.2272 38.3681 14.9075 38.3203 14.5908L38.8145 14.5156L39.3076 14.4414ZM7.08398 12.7012C6.99798 13.0103 6.92112 13.3232 6.85352 13.6396L5.87598 13.4307C5.94786 13.0943 6.02866 12.7613 6.12012 12.4326L7.08398 12.7012ZM38.8789 12.4326C38.9704 12.7613 39.0512 13.0943 39.123 13.4307L38.1465 13.6396C38.0789 13.3232 38.002 13.0103 37.916 12.7012L38.8789 12.4326ZM7.71387 10.876C7.59094 11.1724 7.47638 11.4732 7.37109 11.7783L6.42676 11.4521C6.53872 11.1277 6.65932 10.8074 6.79004 10.4922L7.71387 10.876ZM38.209 10.4922C38.3397 10.8074 38.4603 11.1277 38.5723 11.4521L37.6289 11.7783C37.5236 11.4732 37.4091 11.1724 37.2861 10.876L38.209 10.4922ZM7.69043 8.64746L8.56055 9.13965C8.40232 9.4196 8.25184 9.70505 8.11035 9.99512L7.21191 9.55664C7.32059 9.33386 7.43376 9.11368 7.55176 8.89648L7.69043 8.64746ZM37.3086 8.64746C37.4768 8.94513 37.6366 9.24817 37.7871 9.55664L36.8896 9.99512C36.7482 9.70505 36.5977 9.4196 36.4395 9.13965L37.3086 8.64746ZM9.61133 7.51758C9.42033 7.77673 9.23691 8.04179 9.06152 8.3125L8.22266 7.76855C8.40903 7.4809 8.60371 7.19915 8.80664 6.92383L9.61133 7.51758ZM36.1924 6.92383C36.3953 7.19916 36.59 7.4809 36.7764 7.76855L36.3584 8.04102L36.3574 8.04004L35.9385 8.3125C35.7631 8.04179 35.5797 7.77673 35.3887 7.51758L36.1924 6.92383ZM10.8496 6.0332C10.6287 6.26783 10.4146 6.50921 10.208 6.75684L9.44043 6.11621C9.65977 5.85331 9.88751 5.59773 10.1221 5.34863L10.8496 6.0332ZM34.877 5.34863C35.1115 5.59773 35.3392 5.85331 35.5586 6.11621L34.792 6.75684C34.5854 6.50921 34.3713 6.26783 34.1504 6.0332L34.877 5.34863ZM12.2568 4.70801C12.0092 4.9146 11.7678 5.12866 11.5332 5.34961L10.8486 4.62207C11.0977 4.38751 11.3533 4.15977 11.6162 3.94043L12.2568 4.70801ZM33.3828 3.94043C33.6457 4.15976 33.9013 4.38751 34.1504 4.62207L33.4668 5.34961C33.2322 5.12866 32.9908 4.9146 32.7432 4.70801L33.3828 3.94043ZM13.2686 2.72266L13.541 3.1416L13.8125 3.56152C13.5418 3.73691 13.2767 3.92033 13.0176 4.11133L12.4238 3.30664C12.6114 3.16841 12.8018 3.03391 12.9951 2.90332L13.2686 2.72266ZM31.7305 2.72266C32.0181 2.90902 32.2999 3.10371 32.5752 3.30664L31.9824 4.11133C31.7233 3.92033 31.4582 3.73691 31.1875 3.56152L31.459 3.1416L31.7305 2.72266ZM15.4951 2.61035C15.2051 2.75185 14.9196 2.90232 14.6396 3.06055L14.1475 2.19043C14.4451 2.02219 14.7482 1.86238 15.0566 1.71191L15.4951 2.61035ZM29.9424 1.71191C30.2509 1.86236 30.5539 2.0222 30.8516 2.19043L30.3604 3.06055C30.0804 2.90232 29.7949 2.75184 29.5049 2.61035L29.9424 1.71191ZM17.2783 1.87109C16.9732 1.97638 16.6724 2.09094 16.376 2.21387L15.9922 1.29004C16.3074 1.15932 16.6277 1.03872 16.9521 0.926758L17.2783 1.87109ZM28.0469 0.926758C28.3713 1.03871 28.6916 1.15933 29.0068 1.29004L28.624 2.21387C28.3276 2.09094 28.0268 1.97638 27.7217 1.87109L28.0469 0.926758ZM19.1396 1.35352C18.8232 1.42112 18.5103 1.49798 18.2012 1.58398L17.9326 0.620117C18.2613 0.528658 18.5943 0.447855 18.9307 0.375977L19.1396 1.35352ZM26.0684 0.375977C26.4048 0.447838 26.7377 0.528675 27.0664 0.620117L26.7988 1.58398C26.4897 1.49798 26.1768 1.42112 25.8604 1.35352L26.0684 0.375977ZM21.0498 1.06445C20.7272 1.09341 20.4075 1.1319 20.0908 1.17969L20.0156 0.68457L19.9414 0.191406C20.2781 0.140583 20.6181 0.100105 20.9609 0.0693359L21.0498 1.06445ZM24.0381 0.0693359C24.381 0.100085 24.7209 0.140601 25.0576 0.191406L24.9844 0.685547L24.9834 0.68457L24.9092 1.17969C24.5925 1.1319 24.2728 1.09341 23.9502 1.06445L24.0381 0.0693359ZM22.5 0C22.6718 0 22.8431 0.00274942 23.0137 0.0078125L22.9854 1.00684C22.8243 1.00205 22.6623 1 22.5 1C22.3377 1 22.1757 1.00205 22.0146 1.00684L21.9854 0.0078125C22.1563 0.00273016 22.3278 0 22.5 0Z" fill="#7054FA"/>
                            <path d="M25.3867 17L22.5 19.8867L20.1133 17.5H0.5C0.223858 17.5 -5.17733e-10 17.2761 0 17C2.41411e-08 16.7239 0.223858 16.5 0.5 16.5H20.1133L22.5 14.1133L25.3867 17Z" fill="white"/>
                        </svg>
                    </div>
                </div>
            </div>
            <div class="info-divider-horizontal"></div>
        </div>

        <!-- Skills panel -->
        <div id="skills-panel" class="collapsible-panel">
            <div id="skills-header" class="panel-header" role="button" tabindex="0" aria-expanded="false">
                <span class="panel-label">SKILLS</span>
                <button id="skills-toggle" class="panel-toggle">EXPAND</button>
            </div>
            <div id="skills-content" class="panel-content" aria-hidden="true">
                <!-- Dynamic skill items rendered here -->
            </div>
        </div>

        <!-- Inventory panel -->
        <div id="inventory-panel" class="collapsible-panel">
            <div id="inventory-header" class="panel-header" role="button" tabindex="0" aria-expanded="false">
                <span class="panel-label">INVENTORY [<span id="inventory-count">0</span>]</span>
                <button id="inventory-toggle" class="panel-toggle">EXPAND</button>
            </div>
            <div id="inventory-items" class="panel-content" aria-hidden="true">
                <div class="inventory-item">Empty</div>
            </div>
        </div>

        <!-- Game menu -->
        <div id="game-menu">
            <div class="flex-row">
                <button class="menu-btn primary" id="save-btn">SAVE GAME</button>
                <button class="menu-btn primary" id="load-btn">LOAD GAME</button>
            </div>
            <button class="menu-btn secondary" id="new-game-btn">NEW GAME</button>
        </div>
    </main>

    <!-- API Key Modal -->
    <div id="api-key-modal" class="modal" role="dialog" aria-labelledby="api-key-title">
        <div class="modal-content">
            <h2 id="api-key-title">Enter Claude API Key</h2>
            <p>You've selected Claude API mode, which provides the best narrative quality. You'll need a Claude API key to play.</p>
            <p><strong>Note:</strong> Your API key is stored locally in your browser and is never sent to any server except Anthropic's API. API usage will be billed to your Anthropic account.</p>
            <p><em>Alternatively, you can switch to WebLLM mode in Settings for free, offline gameplay (with simpler narratives).</em></p>
            <label for="api-key-input">API Key:</label>
            <input
                type="password"
                id="api-key-input"
                placeholder="sk-ant-..."
                autocomplete="off"
            />
            <div class="modal-buttons">
                <button class="modal-btn" id="api-key-submit">Start Playing</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal" role="dialog" aria-labelledby="settings-title">
        <div class="modal-content">
            <h2 id="settings-title">Settings</h2>

            <label>AI Model:</label>
            <div class="settings-section">
                <label class="settings-label">
                    <div class="settings-label-header">
                        <input type="radio" name="ai-model" value="claude" id="model-claude" checked>
                        Claude API
                    </div>
                    <div class="settings-description">
                        Best quality, requires API key
                    </div>
                </label>
                <label class="settings-label">
                    <div class="settings-label-header">
                        <input type="radio" name="ai-model" value="webllm" id="model-webllm">
                        WebLLM - Llama 3.2
                    </div>
                    <div class="settings-description">
                        Free, runs in browser, ~2GB download
                    </div>
                </label>
            </div>

            <label for="font-size-select">Font Size:</label>
            <select id="font-size-select">
                <option value="18">Small (18px)</option>
                <option value="20" selected>Medium (20px)</option>
                <option value="22">Large (22px)</option>
                <option value="24">Extra Large (24px)</option>
            </select>

            <label for="narrative-length-select">Narrative Length:</label>
            <select id="narrative-length-select">
                <option value="concise">Concise (~300 chars)</option>
                <option value="regular" selected>Regular (1-2 paragraphs)</option>
            </select>

            <label for="auto-save-toggle">
                <input type="checkbox" id="auto-save-toggle" checked> Enable auto-save
            </label>

            <label for="eink-mode-toggle">
                <input type="checkbox" id="eink-mode-toggle"> E-Ink Mode
            </label>

            <div class="settings-action-section">
                <button class="modal-btn secondary" id="change-api-key-btn">Change API Key</button>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn" id="settings-close">Close</button>
            </div>
        </div>
    </div>

    <!-- Save Game Modal -->
    <div id="save-modal" class="modal" role="dialog" aria-labelledby="save-title">
        <div class="modal-content">
            <h2 id="save-title">Save Game</h2>
            <div id="save-slots">
                <!-- Save slots will be dynamically generated -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="save-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Game Modal -->
    <div id="load-modal" class="modal" role="dialog" aria-labelledby="load-title">
        <div class="modal-content">
            <h2 id="load-title">Load Game</h2>
            <div id="load-slots">
                <!-- Load slots will be dynamically generated -->
            </div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="load-cancel">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Continue or New Game Modal -->
    <div id="continue-modal" class="modal" role="dialog" aria-labelledby="continue-title">
        <div class="modal-content">
            <h2 id="continue-title">Welcome Back</h2>
            <p>Auto-save detected. Continue your previous game or start a new one?</p>
            <div class="modal-buttons">
                <button class="modal-btn" id="continue-btn">Continue</button>
                <button class="modal-btn secondary" id="start-new-btn">New Game</button>
            </div>
        </div>
    </div>

    <!-- Skill Spending Modal -->
    <div id="skill-spend-modal" class="modal" role="dialog" aria-labelledby="skill-spend-title">
        <div class="modal-content">
            <h2 id="skill-spend-title">Spend Skill Points?</h2>
            <p>Skill: <strong id="skill-name-display">-</strong></p>
            <p>Available Points: <strong id="available-points-display">0</strong></p>
            <p>Spend points to increase your chance of success. Each point spent adds +1 to your dice roll.</p>

            <label for="points-slider">Points to spend:</label>
            <input type="range" id="points-slider" min="0" max="5" value="0" class="slider-container">

            <div class="bonus-display">
                Bonus: +<span id="bonus-display">0</span>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn" id="spend-and-roll-btn">Roll with Bonus</button>
                <button class="modal-btn secondary" id="skip-spend-btn">Roll without Bonus</button>
                <button class="modal-btn secondary" id="cancel-action-btn">Cancel</button>
            </div>
        </div>
    </div>

    <script src="js/game.js"></script>
</body>
</html>
